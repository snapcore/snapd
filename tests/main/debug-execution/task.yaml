summary: Verify snap debug execution command

details: |
    This test checks that the command `snap debug execution` shows right
    outputs, but also verifies their correctness on the target systems

execute: |
    snap debug execution snap > snap-default.out
    SNAP_REEXEC=0 snap debug execution snap > snap-no-reexec.out
    SNAP_REEXEC=1 snap debug execution snap > snap-yes-reexec.out

    snap debug execution apparmor > snap-apparmor-default.out
    SNAP_REEXEC=0 snap debug execution apparmor > snap-apparmor-no-reexec.out

    snap debug execution internal-tool --tool snap-update-ns > snap-uns-default.out

    case "$SPREAD_SYSTEM" in
        ubuntu-*|debian-*)
            MATCH 'distro-supports-reexec: true' < snap-default.out
            MATCH 'is-reexec-enabled: true' < snap-default.out
            MATCH 'is-reexec-explicitly-enabled: false' < snap-default.out
            MATCH 'is-reexecd: true' < snap-default.out
            MATCH 'self-exe: /snap/snapd/.*/usr/bin/snap' < snap-default.out

            MATCH 'distro-supports-reexec: true' < snap-no-reexec.out
            MATCH 'is-reexec-enabled: false' < snap-no-reexec.out
            MATCH 'is-reexec-explicitly-enabled: false' < snap-no-reexec.out
            MATCH 'is-reexecd: false' < snap-no-reexec.out
            MATCH 'self-exe: /usr/bin/snap' < snap-no-reexec.out

            MATCH 'apparmor-parser: /snap/snapd/.*/usr/lib/snapd/apparmor_parser' < snap-apparmor-default.out
            MATCH 'internal: true' < snap-apparmor-default.out

            MATCH 'apparmor-parser: /usr/lib/snapd/apparmor_parser' < snap-apparmor-no-reexec.out
            MATCH 'internal: false' < snap-apparmor-no-reexec.out

            MATCH 'snap-update-ns: /usr/lib/snapd/snap-update-ns' < snap-uns-default.out
            ;;
        *)
            MATCH 'distro-supports-reexec: false' < snap-default.out
            MATCH 'is-reexec-enabled: true' < snap-default.out
            MATCH 'is-reexec-explicitly-enabled: false' < snap-default.out
            MATCH 'is-reexecd: false' < snap-default.out
            MATCH 'self-exe: /usr/bin/snap' < snap-default.out

            MATCH 'distro-supports-reexec: false' < snap-yes-reexec.out
            MATCH 'is-reexec-enabled: true' < snap-yes-reexec.out
            MATCH 'is-reexec-explicitly-enabled: true' < snap-yes-reexec.out
            MATCH 'is-reexecd: false' < snap-yes-reexec.out
            MATCH 'self-exe: /snap/snapd/.*/usr/bin/snap' < snap-yes-reexec.out

            MATCH 'apparmor-parser: /usr/lib/snapd/apparmor_parser' < snap-apparmor-default.out
            MATCH 'internal: false' < snap-apparmor-default.out

            MATCH 'snap-update-ns: /usr/lib(exec)?/snapd/snap-update-ns' < snap-uns-default.out
            ;;
    esac

